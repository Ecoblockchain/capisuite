<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Structural overview of the default scripts</title><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /><link rel="home" href="index.html" title="CapiSuite 0.5.git" /><link rel="up" href="ch02.html" title="Chapter 2. Users Guide" /><link rel="prev" href="ch02s05.html" title="Example for an idle script" /><link rel="next" href="ch02s07.html" title="CapiSuite command reference" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Structural overview of the default scripts</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02s05.html">Prev</a> </td><th width="60%" align="center">Chapter 2. Users Guide</th><td width="20%" align="right"> <a accesskey="n" href="ch02s07.html">Next</a></td></tr></table><hr /></div><div class="sect1" title="Structural overview of the default scripts"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="default_script_overview"></a>Structural overview of the default scripts</h2></div></div></div><div class="sect2" title="incoming.py"><div class="titlepage"><div><div><h3 class="title"><a id="default_incoming"></a>incoming.py</h3></div></div></div><p>The incoming script handles all incoming connections. It reads two configuration files containing all necessary
			data which were described in detail in <a class="xref" href="ch01s03.html#script_config" title="Script configuration">the section called “Script configuration”</a>. The overall structure will be described here
			giving you an overview of how it is implemented.</p><p>First (after importing some necessary modules), it defines the necessary function <code class="function">callIncoming</code>
			which will call all other functions if needed.</p><div class="sect3" title="function callIncoming"><div class="titlepage"><div><div><h4 class="title"><a id="default_incoming_1"></a>function <code class="function">callIncoming</code></h4></div></div></div><p>This function starts with a call to <code class="function">cs_helpers.readConfig</code>
				to read the configuration. It then iterates through all sections representing the configured users (except
				<code class="literal">GLOBAL</code>) to see if the called number belongs to any user. If a match is found, the user and
				the defined service are saved to <code class="literal">curr_user</code> and <code class="literal">curr_service</code>.</p><p>If no match was found (<code class="literal">curr_user</code> is empty), the call is
				rejected and the function returns. Otherwise the call is accepted and - depending
				on the service used - <code class="function">faxIncoming</code> or
				<code class="function">voiceIncoming</code> is called.</p><p>The function also defines an exeception handler for <code class="literal">capisuite.CallGoneError</code>.</p></div><div class="sect3" title="function faxIncoming"><div class="titlepage"><div><div><h4 class="title"><a id="default_incoming_2"></a>function <code class="function">faxIncoming</code></h4></div></div></div><p>First of all, the directory to use for incoming fax data is determined and created
				if not existing yet, the existence of the given user is checked and a log entry is written.</p><p>It then switches to fax mode if necessary, creates a uniqe filename, calls
				<code class="function">capisuite.fax_receive</code>, disconnects and logs the disconnection reasons.
				Then it checks if a fax has been really received succesfully (i.e. if the file exists). If yes, it creates a description file for it,
				<span class="command"><strong>chown</strong></span>'s the file to the right user and sends the file as mail.</p></div><div class="sect3" title="function voiceIncoming"><div class="titlepage"><div><div><h4 class="title"><a id="default_incoming_3"></a>function <code class="function">voiceIncoming</code></h4></div></div></div><p><code class="function">voiceIncoming</code> has much more features to accomplish like fax recognition
				and switching to fax mode, starting a remote inquiry etc.</p><p>It starts by determining the directory to use and creating a unique filename. Also, the PIN for remote inquiry
				is saved to a private variable. There are two possibilites now: the user has already an own announcement - in this case
				it's played now. Otherwise, a predefined announcement containing of a general announcement and the number which was called
				is played. If recording a message wasn't disabled (by setting <code class="literal">voice_action</code> to <code class="literal">None</code>),
				it starts now after a beep.</p><p>All <code class="function">audio_send</code> and <code class="literal">audio_receive</code> calls used so far had DTMF abortion enabled
				and so the script "falls through" all these calls after a DTMF signal was recognized. After them,
				<code class="function">read_DTMF</code> is used to see if any such signal have been found. "<code class="literal">X</code>" represents the fax
				tone and triggers a switch to fax protocols and a call to <code class="function">faxIncoming</code>. Any other received signals
				are interpreted to be a part of the PIN for remote inquiry and so a loop which waits 3 seconds after each tone for the next
				one is entered. If a valid PIN is entered, it starts the <code class="function">remoteInquiry</code>. After three wrong attempts,
				it will disconnect.</p><p>After disconnecting and logging, a description file is written (if the recorded file exists), both files will be
				<span class="command"><strong>chown</strong></span>'ed to the right user and the recorded message will be mailed to him/her.</p></div><div class="sect3" title="function remoteInquiry"><div class="titlepage"><div><div><h4 class="title"><a id="default_incoming_4"></a>function <code class="function">remoteInquiry</code></h4></div></div></div><p>The <code class="function">remoteInquiry</code> starts by creating a lock file and acquiring an
				exclusive lock on it to prevent two parallel remote inquiries for the same user. If the lock
				can't be acquired, an error message is played and the function returns. If locking has succeeded,
				a list of the recorded voice calls is compiled by listing the user directory, filtering and
				sorting it. Now, a file called <code class="filename">last_inquiry</code> is read when it exists.
				It contains the number of the last heard message. With this information, the old messages can
				be filtered out to a separate list and thus the caller can listen to messages he doesn't know
				already first.</p><p>The number of new messages is said, followed by a small menu where the caller can choose
				to either record an announcment or hear the recorded messages. If he chooses announcement
				recording, the function <code class="function">newAnnouncement</code> is called, otherwise
				<code class="function">remoteInquiry</code> will continue.</p><p>Now, a loop will first iterate over the new and then the all old messages. It starts by
				telling the caller how much messages have been found. Then all messages will be played, repeating
				the following steps for each one:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>read the description file of the current message</p></li><li class="listitem"><p>play an information block containing the current message number, source, destination, date and time of the 
						  call.</p></li><li class="listitem"><p>play the message</p></li><li class="listitem"><p>provide a menu where the caller can go on to the next or last message, repeat the current message or delete
						  it</p></li></ul></div><p>At the end, the caller will be informed that no more messages are available and the connection will be finished, followed
				by releasing the lock file and deleting it.</p></div><div class="sect3" title="function newAnnouncement"><div class="titlepage"><div><div><h4 class="title"><a id="default_incoming_5"></a>function <code class="function">newAnnouncement</code></h4></div></div></div><p><code class="function">newAnnouncement</code> presents some instructions to the caller first. Then, the new announcement will be 
				recorded to a temporary file. To give the user the ability to check it, it will be played, followed by a menu allowing him/her to
				save it or to repeat the recording. If the user has chosen to save it, it will be moved from the temporary file to
				<code class="filename">announcement.la</code> in the users voice directory and <span class="command"><strong>chown</strong></span>'ed to him/her. The call will be
				finished with an approval to the caller that it has been saved succesfully.</p></div></div><div class="sect2" title="idle.py"><div class="titlepage"><div><div><h3 class="title"><a id="default_idle"></a>idle.py</h3></div></div></div><p>The idle script is responsible for collecting jobs from the send queues (where they're stored by <span class="command"><strong>capisuitefax</strong></span>)
			and sending them to the given destinations. It reads its configuration from the files presented in <a class="xref" href="ch01s03.html#script_config" title="Script configuration">the section called “Script configuration”</a>, too.
			</p><div class="sect3" title="function idle"><div class="titlepage"><div><div><h4 class="title"><a id="default_idle_1"></a>function <code class="function">idle</code></h4></div></div></div><p>After reading the configuration by calling <code class="function">cs_helpers.readConfig</code> and testing for the existence
				of the archive directories needed, the userlist is compiled from the list of available sections.</p><p>For each user who has a valid fax setup (otherwise this user will be skipped), the send queue will be looked at. If the
				necessary queue directories don't exist, they'll be created. After that, a list called <code class="literal">files</code> with the names of
				all files in the send queue is created and filtered to only contain fax jobs.</p><p>For each found job, a security check is done to see if it was created by the right user. If this check was successful, a
				lock file is created and a lock on it is acquired. This prevents the <span class="command"><strong>capisuitefax</strong></span> command to abort a job while
				it is in transfer. After that, the existence of the file is checked (perhaps the job has been cancelled before we could acquire 
				the lock?).</p><p>Now, the description file for this job is read and the starttime is checked. If it's not reached, the script will go on with
				the next job. Otherwise, some parameters are taken from the configuration and a log message is created. The file is transferred by 
				calling <code class="function">sendfax</code>. The results are stored and logged. If the job was successful, it is moved to the done dir and
				an approval is mailed to the user. If it wasn't succesful, the delay interval will be determined from the configuration and the new
				starttime is calculated by increasing the old starttime by this interval. A counter for the used tries is increased and the description
				file is rewritten with the new values. If the number of tries exceeds a given maximum, the job is moved to the failed dir and the
				error is reported to the user by mail.</p><p>Finally, the lock file will be unlocked and deleted.</p></div><div class="sect3" title="function sendfax"><div class="titlepage"><div><div><h4 class="title"><a id="default_idle_2"></a>function <code class="function">sendfax</code></h4></div></div></div><p>This function handles the send process. After determining the MSN to use from either the <code class="literal">outgoing_MSN</code>
				setting or from the <code class="literal">fax_numbers</code> list, a call to the destination is initiated. If it fails, the function returns;
				otherwise the file will be sent and the connection finished.</p></div><div class="sect3" title="function movejob"><div class="titlepage"><div><div><h4 class="title"><a id="default_idle_3"></a>function <code class="function">movejob</code></h4></div></div></div><p>This is a small helper function used for moving a job and its accompanying description file to another directory.</p></div></div><div class="sect2" title="capisuitefax"><div class="titlepage"><div><div><h3 class="title"><a id="default_capisuitefax"></a>capisuitefax</h3></div></div></div><p><span class="command"><strong>capisuitefax</strong></span> allows to enqueue fax jobs, list the current queue and abort jobs. It's not used directly by the
			<span class="application">CapiSuite</span> system - it's a frontend for the users send queue directory. It has several commandline options - for an explanation
			of its usage, please refer to <a class="xref" href="ch01s04.html#usingscripts_send" title="Sending fax jobs">the section called “Sending fax jobs”</a>.</p><p>There are three helper functions defined first. <span class="emphasis"><em><code class="function">usage</code></em></span> prints out a small help if
			"<code class="option">--help</code>" or "<code class="option">-h</code>" was given as parameter or if a parameter isn't understood. <span class="emphasis"><em><code class="function">showlist</code></em></span> gets a listing from the users send queue directory and prints it nicely formatted as table. <span class="emphasis"><em>
			<code class="function">abortjob</code></em></span> removes a job from the queue. It does this safely by using a lock file to not interfere with
			the sending process.</p><p>The main code of this script checks the given commandline options first. It sets several variables to the given values.
			After some checks of the validity of the options, the rights of the user to send faxes and the existence of the necessary
			directories, it will fulfill the requested task. Either, <code class="function">listqueue</code> will be called to show a listing of
			active jobs, <code class="function">abortjob</code> to abort a job or the given files are processed and put to the queue.</p><p>To process a job, the existence of it and its format will be checked. Currently, only PostScript is allowed. The <span class="application">CapiSuite</span> core
			itself only supports the SF format. Therefore, the files are converted from PostScript to it by calling
			<span class="command"><strong>ghostscript</strong></span>. Finally, the description file for this job is created containing the given parameters like the
			destination number.</p></div><div class="sect2" title="cs_helpers.py"><div class="titlepage"><div><div><h3 class="title"><a id="default_helpers"></a>cs_helpers.py</h3></div></div></div><p>The <code class="filename">cs_helpers.py</code> script contains many small helper functions used in the other scripts. These are:</p><div class="variablelist"><dl><dt><span class="term"><code class="function">readConfig</code></span></dt><dd><p>Reads either the configuration files described in <a class="xref" href="ch01s03.html#script_config" title="Script configuration">the section called “Script configuration”</a> or an arbitrary
					config file like the description files accompanying each received file or job to send.</p></dd><dt><span class="term"><code class="function">escape</code></span></dt><dd><p>"Escapes" a file name - this means puts it into quotation marks to be able to
					call external tools with it as parameter savely and correctly even if the name contains
					special characters or whitespaces.</p></dd><dt><span class="term"><code class="function">getOption</code></span></dt><dd><p>Get an option from the given user section and fall back to the global section if it's not found.</p></dd><dt><span class="term"><code class="function">getAudio</code></span></dt><dd><p>Get an audio file from the users directory or fall back to the global <span class="application">CapiSuite</span> directory.</p></dd><dt><span class="term"><code class="function">uniqueName</code></span></dt><dd><p>Construct a new file name in a given directory by using a given prefix &amp; suffix and adding a counter. See
					also <a class="xref" href="ch02s04.html#incoming_tut_unique_names" title="Using sensible file names">the section called “Using sensible file names”</a>.</p></dd><dt><span class="term"><code class="function">sendMIMEMail</code></span></dt><dd><p>Send an e-mail with attachment to a given user. Supports also automatic format conversion SFF -&gt; PDF and
					inversed A-Law -&gt; WAV.</p></dd><dt><span class="term"><code class="function">sendSimpleMail</code></span></dt><dd><p>Send a normal e-mail without attachment to a given user.</p></dd><dt><span class="term"><code class="function">writeDescription</code></span></dt><dd><p>Create a description file which can be read by <code class="function">readConfig</code> later.</p></dd><dt><span class="term"><code class="function">sayNumber</code></span></dt><dd><p>Supports saying a number using various wave fragments. Works only for german output currently.</p></dd></dl></div><p>For a detailled description of each function and its usage, please have a look at the script file itself. There are
			comments describing each function in detail.</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02s05.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch02.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch02s07.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Example for an idle script </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> <span class="application">CapiSuite</span> command reference</td></tr></table></div></body></html>
